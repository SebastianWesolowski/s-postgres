echo "[ğŸ¶ Husky] Running prepare-commit-msg hook..."

commit_msg_file="$1"
commit_source="$2"
# Funkcja do debugowania
debug() {
    local commit_msg=$(cat "$commit_msg_file")
    if [[ "$commit_msg" == *"-d"* ]]; then
        echo "DEBUG: $1"
    fi
}


debug "Starting prepare-commit-msg hook"


debug "commit_msg_file=$commit_msg_file, commit_source=$commit_source"

# Extract emoji from commit message
get_emoji() {
    local emoji=$([[ $1 =~ [âœ¨ğŸ›ğŸ“šï¸ğŸ’„â™»ï¸âš¡ğŸš¨ğŸ“¦ğŸ¡ğŸ”§âª] ]] && echo "${BASH_REMATCH[0]}")
    debug "Extracted emoji: $emoji"
    echo "$emoji"
}

# Extract issue number from commit message
get_issue_number() {
    local issue=$(echo "$1" | grep -oE "SC-[0-9]+" | head -n1)
    debug "Extracted issue number: ${issue:-NO-TICKET}"
    echo "${issue:-NO-TICKET}"
}

# Extract commit message content
get_commit_message() {
    local commit_msg="$1"
    local used_emoji="$2"
    local issue_number="$3"
    debug "Processing commit message: $commit_msg"
    debug "With emoji: $used_emoji"
    debug "With issue: $issue_number"

    local content=$(echo "$commit_msg" | sed -E 's/^[^:]+: *//; s/^[[:space:]]*'"$used_emoji"'[[:space:]]*//' |
        sed -E 's/[[:space:]]*'"$issue_number"'[[:space:]]*//')
    debug "Extracted content: $content"
    echo "$content"
}

# Extract commit type
get_commit_type() {
    local commit_type=$(echo "$1" | sed -nE 's/^([a-z]+):.*/\1/p')
    local valid_types="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
    debug "Extracted commit type: $commit_type"
    [[ -n "$commit_type" && "$commit_type" =~ ^($valid_types)$ ]] && echo "$commit_type" || echo ""
}

# Update commit message file
update_commit_message() {
    local commit_type="$1"
    local emoji="$2"
    local issue_number="$3"
    local commit_content="$4"
    local commit_msg_file="$5"

    debug "Updating commit message with:"
    debug "type=$commit_type"
    debug "emoji=$emoji"
    debug "issue=$issue_number"
    debug "content=$commit_content"

    if [ "$issue_number" = "NO-TICKET" ]; then
        echo "$commit_type: $emoji $commit_content" > "$commit_msg_file"
    else
        echo "$commit_type: $emoji [$issue_number] $commit_content" > "$commit_msg_file"
    fi
    sed -i.bak '/^$/d' "$commit_msg_file" && rm "${commit_msg_file}.bak"
    debug "Final commit message: $(cat $commit_msg_file)"
}


# Skip processing for amend commits
if [ "$commit_source" = "commit" ] || [ "$commit_source" = "message" ]; then
    debug "Amend commit detected, skipping"
    echo "[ğŸ¶ Husky] â­ï¸ Amend commit detected. Skipping prepare-commit-msg script."
    echo "[ğŸ¶ Husky] Done âœ… prepare-commit-msg hook..."
    exit 0
fi

# Skip validation for release commits
if [[ "$(git log -1 --pretty=%B)" == *"release:"* ]]; then
    debug "Release commit detected, skipping"
    exit 0
fi

# Skip validation for merge commits
if [[ "$(git log -1 --pretty=%B)" == *"Merge pull request"* ]]; then
    debug "Merge commit detected, skipping"
    exit 0
fi

# Run commitlint
debug "Running commitlint"
commitlint_output=$(yarn commitlint --edit "$commit_msg_file" 2>&1)
commitlint_exit_code=$?
debug "Commitlint exit code: $commitlint_exit_code"

if [ "$commitlint_exit_code" -ne 1 ]; then
    debug "Commitlint failed, starting wizard"
    echo "[ğŸ¶ Husky] Commitlint failed. Starting wizard commit message."
    yarn husky:prepare-commit-msg
else
    debug "Commitlint passed"
    echo "[ğŸ¶ Husky] Commitlint passed. Proceeding with the commit."
fi

format_commit_message() {
    debug "Starting format_commit_message"
    commit_msg=$(cat "$commit_msg_file")
    debug "Original commit message: $commit_msg"
    emoji=$(get_emoji "$commit_msg")
    commit_type=$(get_commit_type "$commit_msg")
    issue_number=$(get_issue_number "$commit_msg")
    commit_content=$(get_commit_message "$commit_msg" "$emoji" "$issue_number")
    update_commit_message "$commit_type" "$emoji" "$issue_number" "$commit_content" "$commit_msg_file"
}

format_commit_message
debug "Finished processing"
debug "Final commit message: $(cat $commit_msg_file)"

if [[ "$(cat $commit_msg_file)" == *"-d"* ]]; then
    echo "DEBUG: Debug mode enabled - commit will not be created"
    exit 1
fi

echo "[ğŸ¶ Husky] Done âœ… prepare-commit-msg hook..."
